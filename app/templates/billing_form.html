<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Billing - Create Bill</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body {
      background-color: #f8f9fa;
    }
    .form-section {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    h1, h3 {
      font-weight: 600;
    }
    .price-preview {
      font-weight: 500;
      color: #0d6efd;
    }
    .denom label {
      font-weight: 500;
    }
    .btn-add {
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="container py-4">
    <h1 class="text-center mb-4">ðŸ§¾ Create Bill</h1>
    <form method="post" action="/generate-bill">

      <!-- Customer Section -->
      <div class="form-section">
        <div class="mb-3">
          <label class="form-label">Customer Email</label>
          <input name="customer_email" type="email" class="form-control" placeholder="Enter customer email" required>
        </div>
      </div>

      <!-- Products Section -->
      <div class="form-section">
        <h3>Products Purchased</h3>
        <div class="table-responsive">
          <table class="table table-bordered table-striped align-middle">
            <thead class="table-dark">
              <tr>
                <th>Product ID</th>
                <th>Quantity</th>
                <th>Unit Price (preview)</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="product-rows">
              <!-- dynamic rows -->
            </tbody>
          </table>
        </div>
        <button type="button" class="btn btn-primary btn-sm btn-add" onclick="addRow()">âž• Add Product</button>
      </div>

      <!-- Denominations Section -->
      <div class="form-section">
        <h3>Available Denominations (shop)</h3>
        <div class="row denom">
          <div class="col-6 col-md-3 mb-2">
            <label>â‚¹2000</label>
            <input name="denom_2000" type="number" min="0" value="0" class="form-control">
          </div>
          <div class="col-6 col-md-3 mb-2">
            <label>â‚¹500</label>
            <input name="denom_500" type="number" min="0" value="0" class="form-control">
          </div>
          <div class="col-6 col-md-3 mb-2">
            <label>â‚¹200</label>
            <input name="denom_200" type="number" min="0" value="0" class="form-control">
          </div>
          <div class="col-6 col-md-3 mb-2">
            <label>â‚¹100</label>
            <input name="denom_100" type="number" min="0" value="0" class="form-control">
          </div>
          <div class="col-6 col-md-3 mb-2">
            <label>â‚¹50</label>
            <input name="denom_50" type="number" min="0" value="0" class="form-control">
          </div>
          <div class="col-6 col-md-3 mb-2">
            <label>â‚¹20</label>
            <input name="denom_20" type="number" min="0" value="0" class="form-control">
          </div>
          <div class="col-6 col-md-3 mb-2">
            <label>â‚¹10</label>
            <input name="denom_10" type="number" min="0" value="0" class="form-control">
          </div>
        </div>
      </div>

      <!-- Payment Section -->
      <div class="form-section">
        <div class="mb-3">
          <label class="form-label">Paid Amount</label>
          <input type="number" step="0.01" name="paid_amount" class="form-control" placeholder="Enter amount paid" required>
        </div>
      </div>


      <!-- Submit Button -->
      <div class="text-center">
        <button type="submit" class="btn btn-success btn-lg">ðŸ’³ Generate Bill</button>
      </div>
    </form>

      <!-- Search purchase -->
      <div class="container py-4">
        <form class="form-section" method="get" action="/purchases/">
          <div class="mb-3">
            <label class="form-label">Search Customer Purchases</label>
            <input name="email" type="email" value="{{ email or '' }}" class="form-control" placeholder="Customer email" required />
          </div>
            <button class="btn btn-primary btn-sm" type="submit">Search</button>
        </form>
      </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const products = {
      {% for p in products %}
        "{{p.product_id}}": {name: "{{p.name}}", price: "{{'%.2f' % p.price_per_unit}}", tax: "{{'%.2f' % p.tax_percentage}}"},
      {% endfor %}
    };

    function addRow(productId = '', qty = 1) {
      const tbody = document.getElementById('product-rows');
      const tr = document.createElement('tr');

      tr.innerHTML = `
        <td>
          <div class="input-group">
            <input type="text" class="form-control product-id-input" placeholder="Enter ID" value="${productId}" oninput="matchProductId(this)">
            <select name="product_id" class="form-select product-dropdown" required onchange="updatePricePreview(this)">
              <option value="">-- Select --</option>
              ${Object.entries(products)
                .map(([pid, info]) => `<option value="${pid}" ${pid === productId ? 'selected' : ''}>${pid} â€” ${info.name}</option>`)
                .join('')}
            </select>
          </div>
        </td>
        <td><input type="number" name="quantity" min="1" value="${qty}" class="form-control" required></td>
        <td class="price-preview">-</td>
        <td><button type="button" class="btn btn-danger btn-sm" onclick="this.closest('tr').remove()">ðŸ—‘ Remove</button></td>
      `;
      tbody.appendChild(tr);

      // Set preview if product is pre-selected
      const dropdown = tr.querySelector('.product-dropdown');
      if (productId) updatePricePreview(dropdown);
    }

    function matchProductId(input) {
      const enteredId = input.value.trim();
      const row = input.closest('tr');
      const dropdown = row.querySelector('.product-dropdown');

      if (products[enteredId]) {
        dropdown.value = enteredId;
        updatePricePreview(dropdown);
      } else {
        dropdown.value = "";
        row.querySelector('.price-preview').innerText = '-';
      }
    }

    function updatePricePreview(sel) {
      const pid = sel.value;
      const row = sel.closest('tr');
      const preview = row.querySelector('.price-preview');
      if (products[pid]) {
        preview.innerText = `${products[pid].price} (Tax ${products[pid].tax}%)`;
        // Sync back to text input
        row.querySelector('.product-id-input').value = pid;
      } else {
        preview.innerText = '-';
      }
    }

    // Add initial row
    addRow();
  </script>
</body>
</html>
